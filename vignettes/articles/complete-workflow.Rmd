---
title: "Complete SCM Workflow"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

# Complete Stepwise Covariate Modeling Workflow

This comprehensive guide walks through a complete SCM analysis from start to finish.


## Overview

The stepwise covariate modeling (SCM/SCM+) process consists of:
0. **Backward elimination** :Remove non-significant covariates (optional)
1. **Forward Selection**: Add covariates that improve model fit
2. **Backward Elimination**: Remove non-significant covariates
3. **Final Model**: Select the best parsimonious model

## Prerequisites

```{r prerequisites}
library(CovariateSearcher)
library(dplyr)
```

## Step 1: Prepare Your Data

### NONMEM Dataset
Your dataset should include:
- `ID`: Subject identifier
- `TIME`: Time points
- `DV`: Dependent variable (concentrations)
- `EVID`: Event ID (0=observation, 1=dose)
- Covariates (WT, AGE, SEX, etc.)

```{r data-example}
# Example dataset structure
head(nonmem_data)
#   ID TIME  DV EVID  WT AGE SEX
#    1  0.0  NA    1  70  45   1
#    1  0.5 5.2    0  70  45   1
#    1  1.0 8.1    0  70  45   1
```

### Covariate Search Configuration

Create a CSV file defining which covariates to test:

```{r covariate-config}
# Example: covariate_search.csv
covariate_config <- tribble(
  ~PARAMETER, ~COVARIATE, ~STATUS,        ~FORMULA, ~LEVELS, ~REFERENCE,
  "CL",       "WT",        "continouous",  "power",  NA,      70,
  "CL",       "AGE",       "continouous",  "linear", NA,      50,
  "CL",       "SEX",       "categorical",  "cat",    "0;1",   1,
  "V",        "WT",        "continouous",  "power",  NA,      70
)

write.csv(covariate_config, "data/derived/covariate_search.csv", row.names = FALSE)
```

## Step 2: Initialize Search

```{r initialize}
search_state <- initialize_covariate_search(
  base_model_path = "run10",
  data_file_path = "data/derived/analysis.csv",
  covariate_search_path = "data/covariate_search.csv",
  discover_existing = TRUE, 
  models_folder = "models", 
  threads = 40)

```

## Step 3: Run Forward Selection

```{r forward-selection}
# Standard forward selection
 results <- full_scm_search(
  search_state = search_state,
  base_model_id = "run10",
  scm_type = "standard",      # or "selective"
  starting_phase = "forward",
  full_scm = FALSE,           # This runs ONLY forward selection
  forward_p_value = 0.05,
  rse_threshold = 50,
  auto_submit = TRUE,
  auto_retry = TRUE
)

# Check results
print(results$final_model)
print(results$selected_covariates)
```

### Understanding Selection Criteria

Models are selected if they meet BOTH criteria:
- **Î”OFV > 3.84**: Statistically significant improvement (p < 0.05)
- **RSE < 50%**: Parameter estimates are reasonably precise

## Step 4: Backward Elimination

```{r backward-elimination}
results <- full_scm_search(
  search_state = search_state,
  base_model_id = "run10",
  starting_phase = "backward",
  full_scm = FALSE,            # This runs ONLY the specified phase
  backward_p_value = 0.01,
  auto_submit = TRUE,
  auto_retry = TRUE
)

print(results$final_model)
```

## Step 5: Review Results

```{r review}
search_state <-readRDS("./models/scm_rds/scm_auto_final_complete.rds")
results_table <- create_scm_results_table(search_state)
print_scm_results_table(search_state)
```


## Next Steps

- See [Troubleshooting Guide](troubleshooting.html) for common issues
- See [Recovery System](recovery-system.html) for handling model failures
- See [Case Studies](case-studies.html) for real-world examples

