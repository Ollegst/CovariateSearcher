---
title: "CovariateSearcher: Quick Reference"
author: "CovariateSearcher Package"
date: "`r Sys.Date()`"
output: github_document

---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE,  # Don't execute code examples
  warning = FALSE,
  message = FALSE
)
```


## üöÄ Minimal Working Example

```r
# Install from GitHub
devtools::install_github("Ollegst/CovariateSearcher")

library(CovariateSearcher)

# 1. Initialize
search_state <- initialize_covariate_search(
  base_model_path = "run10",
  data_file_path = "data/derived/analysis.csv",
  covariate_search_path = "data/covariate_search.csv",
  discover_existing = TRUE, 
  models_folder = "models", 
  threads = 40)


# 2. Run SCM
result <- run_automated_scm_testing(
		search_state = search_state,
		scm_type = "selective",                     # or "standard"  
    starting_phase = "backward",                # Starting phase
    full_scm = TRUE,                            # Run complete workflow 
    forward_p_value = 0.05, 	                  # p-value for the forward selection	
    backward_p_value = 0.01,                    # p-value for the backward elimination
    rse_threshold = 50,                         # RSE threshold
    auto_submit = TRUE,                         # if FALSE ‚Äì only model creation 
    auto_retry = TRUE,                          # Retry model in case of failure
    save_checkpoints = TRUE,                    # Save each step
    checkpoint_prefix = "scm_auto",
    final_testing = TRUE)                       # Test excluded covariates form failed model


# 3. Check results
search_state <-readRDS("./models/scm_rds/scm_auto_final_complete.rds")
results_table <- create_scm_results_table(search_state)
print_scm_results_table(search_state)

```

---

## üìã Required Files

### 1. Base Model
`models/run10/run10.ctl` - NONMEM control file

**Requirements**:
```
$THETA
; Simple parameter names 
0.5 ; CL ; L/h ; RATIO
10  ; V  ; L   ; RATIO
; OR numbered format
0.5 ; 1_CL ; L/h ; RATIO
10  ; 2_V  ; L   ; RATIO

$PK
; Use TV_ prefix in PK block for typical values
TV_CL = THETA(1)
TV_V  = THETA(2)
CL = TV_CL * EXP(ETA(1))
V  = TV_V  * EXP(ETA(2))

$OMEGA BLOCK(2)
0.1 ; IIV_CL   ; ; LOG
0.1 ; IIV_CL_V ; ; LOG
0.1 ; IIV_V    ; ; LOG

$SIGMA
0.1 ; RUV ; ; RATIO
```

Format: `value ; NAME ; units ; RATIO|LOG`

**THETA Naming**: Use simple names (e.g., `CL`, `V`) or numbered (e.g., `1_CL`, `2_V`) in $THETA block. Use `TV_` prefix only in $PK/$PRED block.

### 2. Dataset
`data/derived/analysis.csv` - NONMEM dataset with covariates

### 3. Covariate Search
`data/derived/covariates.csv`


|PARAMETER|COVARIATE|STATUS     |FORMULA|LEVELS|REFERENCE|TIME_DEPENDENT|
|---------|---------|-----------|-------|------|---------|--------------|
|CL       |WT       |continuous |power  |NA    |70       |FALSE         |
|CL       |AGE      |continuous |linear |NA    |50       |FALSE         |
|CL       |ECOG     |categorical|linear |0,1;2 |1        |FALSE         |
|V2       |WT       |continuous |power  |NA    |70       |FALSE         |


---

### Save/Load State
```r
save_search_state(search_state, "state.rds")
search_state <- load_search_state("state.rds")
```

---

## üìä Workflow Types

### Standard SCM/SCM+
```r
starting_phase = "forward"
full_scm = TRUE
```
‚ûú Forward ‚Üí Backward

### SCM/SCM+ with start from previously developed model
```r
starting_phase = "backward"
full_scm = TRUE
```
‚ûú Backward ‚Üí Forward ‚Üí Backward

### Backward Only
```r
results <- full_scm_search(
  search_state = search_state,
  base_model_id = "run10",
  starting_phase = "backward",
  full_scm = FALSE,            # This runs ONLY the specified phase
  backward_p_value = 0.01,
  auto_submit = TRUE,
  auto_retry = TRUE
)
```
### Forward only
 ```r
 results <- full_scm_search(
  search_state = search_state,
  base_model_id = "run10",
  scm_type = "standard",      # or "selective"
  starting_phase = "forward",
  full_scm = FALSE,           # This runs ONLY forward selection
  forward_p_value = 0.05,
  rse_threshold = 50,
  auto_submit = TRUE,
  auto_retry = TRUE
)
```
---

## ‚öôÔ∏è Common Parameters

| Parameter          | Default    | Options                 |
|--------------------|------------|-------------------------|
| `scm_type`         | "standard" | "standard", "selective" |
| `starting_phase`   | "forward"  | "forward", "backward"   |
| `full_scm`         | TRUE       | TRUE, FALSE             |
| `forward_p_value`  | 0.05       | 0.001-0.1               |
| `backward_p_value` | 0.01       | 0.001-0.1               |
| `rse_threshold`    | 50         | 0-100                   |
| `auto_submit`      | TRUE       | TRUE, FALSE             |
| `auto_retry`       | TRUE       | TRUE, FALSE             |

---

## üìù Check Results

```r
# Final model
results$final_model

# Final covariates
results$final_covariates

# Excluded covariates
results$excluded_covariates

# View database
View(results$search_state$search_database)

# Summary
cat(results$final_summary)
```

---

## üìà Model Selection Criteria

**Model selected if BOTH**:
1. ŒîOFV > threshold
2. RSE < threshold (default: 50%)

**Thresholds**:
- Forward: ŒîOFV > 3.84 (p=0.05)
- Backward: ŒîOFV > 6.63 (p=0.01)

---

## ‚ö†Ô∏è Common Issues

### Base model validation fails
‚ûú Fix parameter format: `value ; NAME ; units ; RATIO|LOG`

### High RSE rejecting models
‚ûú Increase threshold: `rse_threshold = 100`

### Models failing
‚ûú Check: `search_state$search_database$estimation_issue`

### Need to resume
‚ûú Load checkpoint: `load_search_state("scm_auto_forward_complete.rds")`

---

## üíæ Checkpoints (Auto-saved)

- `scm_auto_forward_complete.rds`
- `scm_auto_initial_backward_complete.rds`
- `scm_auto_final_backward_complete.rds`
- `scm_auto_final_complete.rds`

---

## üé® Parameter Format Examples

### THETA (Population Parameters)
**IMPORTANT**: Use simple names or numbered format in $THETA block (NO TV_ prefix!)

```
$THETA
; Option 1: Simple names (recommended)
(0, 0.5, 100) ; CL ; L/h ; LOG
(0, 10)       ; V  ; L   ; LOG
0.5 FIX       ; KA ; 1/h ; LOG

; Option 2: Numbered format
(0, 0.5, 100) ; 1_CL ; L/h ; LOG
(0, 10)       ; 2_V  ; L   ; LOG
0.5 FIX       ; 3_KA ; 1/h ; LOG
```

**Then in $PK block, use TV_ prefix for typical values:**
```
$PK
TV_CL = THETA(1)  ; Use TV_ prefix here
TV_V  = THETA(2)
TV_KA = THETA(3)

CL = TV_CL * EXP(ETA(1))
V  = TV_V  * EXP(ETA(2))
KA = TV_KA * EXP(ETA(3))
```

**‚úÖ Correct THETA naming**: `CL`, `V`, `KA` or `1_CL`, `2_V`, `3_KA`  
**‚ùå Wrong THETA naming**: `TV_CL`, `TVCL`, `TVV` (don't use TV_ in $THETA block!)

### OMEGA Diagonal
```
$OMEGA
0.1 ; IIV_CL ; ; RATIO
0.1 ; IIV_V  ; ; RATIO
```

### OMEGA BLOCK (One value per line!)
```
$OMEGA BLOCK(2)
0.1 ; IIV_CL    ; ; RATIO
0.1 ; IIV_CL_V  ; ; RATIO
0.1 ; IIV_V     ; ; RATIO
```

### SIGMA
```
$SIGMA
0.1  ; RUV_PROP ; ; RATIO
0.05 ; RUV_ADD  ; mg/L ; RATIO
```

**‚ùå WRONG** (multiple values per line):
```
$OMEGA BLOCK(2)
0.1 ; IIV_CL
0.1 0.1 ; IIV_V      ‚Üê Don't do this!
```

**‚ùå WRONG** (TV_ prefix in THETA block):
```
$THETA
0.5 ; TV_CL ; L/h ; LOG    ‚Üê Don't use TV_ in $THETA block!
0.5 ; 1CL   ; L/h ; LOG     ‚Üê Missing underscore
```

---



---

## üîß Advanced Options

### Selective Forward (Faster)
```r
scm_type = "selective"
```

### Custom Thresholds
```r
forward_p_value = 0.01,    # More stringent
backward_p_value = 0.001,  # Very stringent
rse_threshold = 30         # Stricter
```

### Resume Interrupted
```r
search_state <- load_search_state("scm_auto_forward_complete.rds")
results <- run_backward_elimination(
  search_state,
  starting_model = "run85"
)
```

---

## üìö Documentation

Full guide: `CovariateSearcher_USER_GUIDE.md`

Help in R:
```r
?initialize_covariate_search
?run_automated_scm_testing
?validate_base_model_parameters
```

---

**Quick Start**: Initialize ‚Üí Run ‚Üí Check Results
